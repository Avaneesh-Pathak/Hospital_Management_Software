{% extends 'hms/base.html' %}
{% block content %}
<div class="container mt-4">
    <div class="card shadow-lg">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h2 class="card-title mb-0">
                <i class="fas fa-heartbeat me-2"></i>NICU Vitals for {{ ipd.patient.user.full_name }}
            </h2>
            <div>
                <a href="{% url 'add_nicu_vitals' ipd.id %}" class="btn btn-success btn-lg me-2">
                    <i class="fas fa-plus me-2"></i>Add Vitals
                </a>
                <button id="downloadChart" class="btn btn-light btn-lg">
                    <i class="fas fa-download me-2"></i> Download Chart
                </button>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered table-hover table-striped">
                    <thead class="table-dark">
                        <tr>
                            <th class="fw-bold">Vitals</th>
                            {% for vitals in vitals_list %}
                                <th class="text-center">{{ vitals.time }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Section: Vitals -->
                        <tr class="table-info">
                            <td colspan="{{ vitals_list|length|add:1 }}" class="fw-bold text-center bg-light">
                                <i class="fas fa-thermometer-half me-2"></i>Vitals
                            </td>
                        </tr>
                        <tr>
                            <td class="fw-bold">Temperature (°F)</td>
                            {% for vitals in vitals_list %}
                                <td class="{% if vitals.temperature > 100 %}table-warning{% endif %}">
                                    {{ vitals.temperature|default:"-" }}
                                </td>
                            {% endfor %}
                        </tr>
                        <tr>
                            <td class="fw-bold">Respiratory Rate (b/min)</td>
                            {% for vitals in vitals_list %}
                                <td>{{ vitals.respiratory_rate|default:"-" }}</td>
                            {% endfor %}
                        </tr>
                        <tr>
                            <td class="fw-bold">Pulse Rate (b/min)</td>
                            {% for vitals in vitals_list %}
                                <td>{{ vitals.pulse_rate|default:"-" }}</td>
                            {% endfor %}
                        </tr>
                        <tr>
                            <td class="fw-bold">CFT (sec)</td>
                            {% for vitals in vitals_list %}
                                <td>{{ vitals.cft|default:"-" }}</td>
                            {% endfor %}
                        </tr>
                        <tr>
                            <td class="fw-bold">Skin Color</td>
                            {% for vitals in vitals_list %}
                                <td>{{ vitals.get_skin_color_display|default:"-" }}</td>
                            {% endfor %}
                        </tr>
                        <tr>
                            <td class="fw-bold">Seizure</td>
                            {% for vitals in vitals_list %}
                                <td class="{% if vitals.seizure %}table-danger{% endif %}">
                                    {{ vitals.seizure|yesno:"Yes,No"|default:"-" }}
                                </td>
                            {% endfor %}
                        </tr>
                        <tr>
                            <td class="fw-bold">SpO₂ (%)</td>
                            {% for vitals in vitals_list %}
                                <td class="{% if vitals.spo2 < 90 %}table-warning{% endif %}">
                                    {{ vitals.spo2|default:"-" }}
                                </td>
                            {% endfor %}
                        </tr>
                        <tr>
                            <td class="fw-bold">Oxygen Support</td>
                            {% for vitals in vitals_list %}
                                <td>{{ vitals.oxygen|default:"-" }}</td>
                            {% endfor %}
                        </tr>
                        <tr>
                            <td class="fw-bold">Retraction</td>
                            {% for vitals in vitals_list %}
                                <td class="{% if vitals.retraction %}table-danger{% endif %}">
                                    {{ vitals.retraction|yesno:"Yes,No"|default:"-" }}
                                </td>
                            {% endfor %}
                        </tr>

                        <!-- Section: Fluid Balance -->
                        <tr class="table-info">
                            <td colspan="{{ vitals_list|length|add:1 }}" class="fw-bold text-center bg-light">
                                <i class="fas fa-tint me-2"></i>Fluid Balance
                            </td>
                        </tr>
                        <tr>
                            <td class="fw-bold">IV Fluids (ml)</td>
                            {% for vitals in vitals_list %}
                                <td>{{ vitals.iv_fluids|default:"-" }}</td>
                            {% endfor %}
                        </tr>
                        <tr>
                            <td class="fw-bold">By Nasogastric (ml)</td>
                            {% for vitals in vitals_list %}
                                <td>{{ vitals.by_nasogastric|default:"-" }}</td>
                            {% endfor %}
                        </tr>
                        <tr>
                            <td class="fw-bold">Oral (ml)</td>
                            {% for vitals in vitals_list %}
                                <td>{{ vitals.oral|default:"-" }}</td>
                            {% endfor %}
                        </tr>
                        <tr>
                            <td class="fw-bold">Breastfeeding</td>
                            {% for vitals in vitals_list %}
                                <td>{{ vitals.breastfeeding|yesno:"Yes,No"|default:"-" }}</td>
                            {% endfor %}
                        </tr>

                        <!-- Section: Output -->
                        <tr class="table-info">
                            <td colspan="{{ vitals_list|length|add:1 }}" class="fw-bold text-center bg-light">
                                <i class="fas fa-clipboard-check me-2"></i>Output
                            </td>
                        </tr>
                        <tr>
                            <td class="fw-bold">Urine</td>
                            {% for vitals in vitals_list %}
                                <td>
                                    {% if vitals.urine == "ml" %}
                                        {{ vitals.urine_value|default:"-" }} ml
                                    {% else %}
                                        {{ vitals.get_urine_display|default:"-" }}
                                    {% endif %}
                                </td>
                            {% endfor %}
                        </tr>
                        <tr>
                            <td class="fw-bold">Stool</td>
                            {% for vitals in vitals_list %}
                                <td>{{ vitals.stool|yesno:"Yes,No"|default:"-" }}</td>
                            {% endfor %}
                        </tr>
                        <tr>
                            <td class="fw-bold">IFT (ml)</td>
                            {% for vitals in vitals_list %}
                                <td>{{ vitals.ift|default:"-" }}</td>
                            {% endfor %}
                        </tr>
                        <tr>
                            <td class="fw-bold">Vomiting</td>
                            {% for vitals in vitals_list %}
                                <td class="{% if vitals.vomiting %}table-danger{% endif %}">
                                    {{ vitals.vomiting|yesno:"Yes,No"|default:"-" }}
                                </td>
                            {% endfor %}
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Include html2canvas for downloading the chart as an image -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script>
    document.getElementById("downloadChart").addEventListener("click", function () {
        let chartElement = document.querySelector(".table-responsive");  // Selects the table container
        
        html2canvas(chartElement).then(canvas => {
            let image = canvas.toDataURL("image/png");  // Convert canvas to image
            let link = document.createElement("a");
            link.href = image;
            link.download = "nicu_vitals_chart.png";  // Set the file name
            link.click();
        });
    });
</script>

<style>
    .table th, .table td {
        vertical-align: middle; /* Center align content */
    }
    .table thead th {
        background-color: #343a40; /* Dark header background */
        color: white; /* White text for header */
    }
    .table-striped tbody tr:nth-of-type(odd) {
        background-color: rgba(0, 0, 0, 0.05); /* Light striped rows */
    }
    .table-hover tbody tr:hover {
        background-color: rgba(0, 0, 0, 0.075); /* Hover effect */
    }
    .card {
        border-radius: 15px; /* Rounded corners for the card */
    }
    .btn-lg {
        font-size: 1.1rem; /* Larger buttons */
    }
</style>
{% endblock %}